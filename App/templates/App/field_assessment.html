{% extends 'App/base.html' %}

{% block content %}
<style>
    body { background: #f8fafc; }
    .field-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 1rem;
    }
    .field-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 1.5rem;
    }
    .field-header {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        text-align: center;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 1.5rem;
    }
    .location-btn {
        background: #22c55e;
        color: white;
        border: none;
        border-radius: 15px;
        padding: 1rem;
        width: 100%;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    .assess-btn {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 1.2rem;
        width: 100%;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 1rem 0;
    }
    .form-control {
        border-radius: 15px;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    .form-control:focus {
        border-color: #f97316;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .results-card {
        background: linear-gradient(135deg, #fef3c7, #fbbf24);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        margin: 1.5rem 0;
    }
    .risk-badge {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1rem 2rem;
        border-radius: 25px;
        margin: 1rem 0;
        display: inline-block;
    }
    .risk-high { background: #dc2626; color: white; }
    .risk-extreme { background: #7f1d1d; color: white; }
    .risk-moderate { background: #f59e0b; color: white; }
    .risk-low { background: #16a34a; color: white; }
    .field-tips {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1.5rem 0;
    }
    .quick-btn {
        padding: 1rem;
        border-radius: 15px;
        border: none;
        font-weight: 600;
        text-align: center;
    }
    .btn-save { background: #16a34a; color: white; }
    .btn-export { background: #6b7280; color: white; }
    .btn-report { background: #dc2626; color: white; }
    .btn-weather { background: #0ea5e9; color: white; }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .field-container {
            padding: 0.5rem;
        }
        
        .field-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .field-header {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .field-header h1 {
            font-size: 1.5rem;
        }
        
        .location-btn,
        .assess-btn {
            padding: 0.8rem;
            font-size: 1rem;
        }
        
        .form-control {
            padding: 0.8rem;
            font-size: 1rem;
        }
        
        .results-card {
            padding: 1.5rem;
        }
        
        .risk-badge {
            font-size: 1.2rem;
            padding: 0.8rem 1.5rem;
        }
        
        .quick-actions {
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }
        
        .quick-btn {
            padding: 0.8rem 0.5rem;
            font-size: 0.9rem;
        }
        
        .field-tips {
            padding: 1rem;
        }
        
        .modal-dialog {
            margin: 1rem;
        }
        
        .modal-body {
            padding: 1rem;
        }
    }
    
    @media (max-width: 480px) {
        .field-container {
            padding: 0.25rem;
        }
        
        .field-card {
            padding: 1rem;
            border-radius: 15px;
        }
        
        .field-header {
            padding: 1rem;
            border-radius: 15px;
        }
        
        .field-header h1 {
            font-size: 1.3rem;
        }
        
        .location-btn,
        .assess-btn {
            padding: 0.7rem;
            font-size: 0.9rem;
        }
        
        .form-control {
            padding: 0.7rem;
            font-size: 0.9rem;
        }
        
        .results-card {
            padding: 1rem;
        }
        
        .risk-badge {
            font-size: 1rem;
            padding: 0.6rem 1rem;
        }
        
        .quick-actions {
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .quick-btn {
            padding: 0.6rem 0.3rem;
            font-size: 0.8rem;
        }
        
        .quick-btn i {
            font-size: 1rem;
        }
        
        .field-tips {
            padding: 0.8rem;
        }
        
        .field-tips ul {
            font-size: 0.8rem;
        }
        
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-body {
            padding: 0.8rem;
        }
        
        .modal-header h5 {
            font-size: 1rem;
        }
        
        .btn-lg {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
        }
    }
</style>

<div class="field-container">
    <!-- Header -->
    <div class="field-header">
        <h1><i class="fas fa-fire me-2"></i>Field Assessment</h1>
        <p class="mb-0">Fire Risk Evaluation Tool</p>
        <small class="opacity-75">For field workers and forest rangers</small>
    </div>

    <!-- Location Card -->
    {% if not prediction %}
    <div class="field-card">
        <h5><i class="fas fa-map-marker-alt me-2 text-success"></i>Location</h5>
        
        <button class="location-btn" onclick="getCurrentLocation()">
            <i class="fas fa-crosshairs me-2"></i>Get Current Location
        </button>
        
        <input type="text" id="locationName" class="form-control" placeholder="Location name (e.g., Karura Forest Sector 5)">
        
        <div class="row">
            <div class="col-6">
                <input type="number" id="latitude" class="form-control" placeholder="Latitude" step="0.000001">
            </div>
            <div class="col-6">
                <input type="number" id="longitude" class="form-control" placeholder="Longitude" step="0.000001">
            </div>
        </div>
        
        <div id="locationStatus" class="text-muted small text-center"></div>
    </div>
    {% else %}
    <!-- Location Summary -->
    <div class="field-card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #22c55e;">
        <h5><i class="fas fa-map-marker-alt me-2 text-success"></i>Assessment Location</h5>
        <div class="text-center">
            <div class="h6 text-success mb-1">{{ prediction.lat|floatformat:6 }}, {{ prediction.lon|floatformat:6 }}</div>
            <small class="text-muted">Field Assessment {{ prediction.timestamp|date:"M d, H:i" }}</small>
        </div>
        <button class="btn btn-outline-success btn-sm w-100 mt-2" onclick="newAssessment()">
            <i class="fas fa-plus me-2"></i>New Assessment
        </button>
    </div>
    {% endif %}

    <!-- Assessment Card -->
    {% if not prediction %}
    <div class="field-card">
        <h5><i class="fas fa-chart-line me-2 text-warning"></i>Assessment</h5>
        
        <button class="assess-btn" onclick="conductFieldAssessment()" id="assessButton">
            <i class="fas fa-search me-2"></i>Conduct Fire Risk Assessment
        </button>
    </div>
    {% endif %}
        
    <!-- Results -->
    {% if prediction %}
    <div class="field-card">
        <div class="results-card">
            <h6 class="text-warning mb-3"><i class="fas fa-check-circle me-2"></i>Field Assessment Complete</h6>
            <div class="risk-badge risk-{{ prediction.level|lower }}" id="riskBadge">{{ prediction.level }} RISK</div>
                <div class="row text-center mt-3">
                    <div class="col-4">
                        <strong class="small">Score:</strong><br>
                        <span class="h6">{{ prediction.score }}</span>
                    </div>
                    <div class="col-4">
                        <strong class="small">Temp:</strong><br>
                        <span class="h6">{{ prediction.weather.temp_c|floatformat:0 }}°C</span>
                    </div>
                    <div class="col-4">
                        <strong class="small">Humidity:</strong><br>
                        <span class="h6">{{ prediction.weather.humidity|floatformat:0 }}%</span>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-6">
                        <strong class="small">Wind:</strong><br>
                        <span class="small">{{ prediction.weather.wind_speed_ms|floatformat:1 }} m/s</span>
                    </div>
                    <div class="col-6">
                        <strong class="small">Rain (24h):</strong><br>
                        <span class="small">{{ prediction.weather.rainfall_mm_24h|floatformat:1 }} mm</span>
                    </div>
                </div>
                
                <!-- Field Recommendations -->
                <div class="mt-3 p-3" style="background: rgba(255,255,255,0.8); border-radius: 10px;">
                    <h6 class="mb-2"><i class="fas fa-clipboard-list me-2"></i>Field Recommendations</h6>
                    {% if prediction.level == 'EXTREME' or prediction.level == 'HIGH' %}
                    <div class="text-danger small">
                        <strong>⚠️ HIGH ALERT:</strong><br>
                        • Increase patrol frequency immediately<br>
                        • Prepare firefighting equipment<br>
                        • Alert nearby communities<br>
                        • Restrict access if possible
                    </div>
                    {% elif prediction.level == 'MODERATE' %}
                    <div class="text-warning small">
                        <strong>⚡ MODERATE RISK:</strong><br>
                        • Monitor conditions closely<br>
                        • Check fire breaks<br>
                        • Ensure water access<br>
                        • Brief response teams
                    </div>
                    {% else %}
                    <div class="text-success small">
                        <strong>✅ LOW RISK:</strong><br>
                        • Continue normal patrols<br>
                        • Monitor weather changes<br>
                        • Maintain equipment readiness
                    </div>
                    {% endif %}
                </div>
        </div>
    </div>
    {% elif error %}
    <div class="field-card">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        </div>
    </div>
    {% endif %}

    <!-- Field Tips -->
    <div class="field-tips">
        <h6><i class="fas fa-lightbulb me-2 text-blue-500"></i>Field Assessment Tips</h6>
        <ul class="mb-0 small">
            <li>Check vegetation dryness level</li>
            <li>Note wind direction and speed</li>
            <li>Document nearby water sources</li>
            <li>Assess terrain accessibility</li>
            <li>Record weather conditions</li>
        </ul>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        {% if prediction %}
        <button class="quick-btn btn-save" onclick="saveAssessment()" id="saveBtn">
            <i class="fas fa-check d-block mb-1"></i>Saved
        </button>
        {% else %}
        <button class="quick-btn btn-save d-none" onclick="saveAssessment()" id="saveBtn">
            <i class="fas fa-save d-block mb-1"></i>Save
        </button>
        {% endif %}
        <button class="quick-btn btn-export" onclick="exportReport()">
            <i class="fas fa-download d-block mb-1"></i>Export
        </button>
        <button class="quick-btn btn-report" onclick="reportFire()">
            <i class="fas fa-fire d-block mb-1"></i>Report Fire
        </button>
        <button class="quick-btn btn-weather" onclick="alertTeams()">
            <i class="fas fa-radio d-block mb-1"></i>Alert Teams
        </button>
    </div>

    <!-- Emergency Contact -->
    <div class="field-card text-center">
        <h6 class="text-danger"><i class="fas fa-phone me-2"></i>Emergency Contact</h6>
        <p class="mb-2">Fire Emergency Hotline</p>
        <a href="tel:999" class="btn btn-danger btn-lg">
            <i class="fas fa-phone me-2"></i>Call 999
        </a>
    </div>
</div>

<!-- Fire Report Modal -->
<div class="modal fade" id="fireReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: #dc2626; color: white;">
                <h5 class="modal-title"><i class="fas fa-fire me-2"></i>Report Fire Observation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="fireReportForm">
                    <div class="mb-3">
                        <label class="form-label">What did you observe?</label>
                        <select class="form-control" id="observation" required>
                            <option value="">Select observation...</option>
                            <option value="smoke">Smoke</option>
                            <option value="flames">Flames</option>
                            <option value="heat">Excessive Heat</option>
                            <option value="smell">Burning Smell</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <button type="button" class="btn btn-success w-100 mb-2" onclick="getFireLocation()">
                            <i class="fas fa-crosshairs me-2"></i>Use Current Location
                        </button>
                        <input type="text" class="form-control" id="fireLocation" placeholder="Describe the exact location" required>
                        <div id="fireLocationStatus" class="text-muted small mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="fireNotes" rows="3" placeholder="Size, intensity, wind direction, etc."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Photo Evidence</label>
                        <input type="file" class="form-control" id="fireImage" accept="image/*" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitFireReport()">
                    <i class="fas fa-paper-plane me-2"></i>Submit Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentAssessment = null;

function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('GPS not supported on this device');
        return;
    }

    const btn = document.querySelector('.location-btn');
    const status = document.getElementById('locationStatus');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Getting GPS Location...';
    btn.disabled = true;
    status.textContent = 'Acquiring GPS coordinates...';

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            document.getElementById('locationName').value = `Field Location (${lat.substring(0,6)}, ${lon.substring(0,6)})`;
            
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Location Acquired';
            btn.style.background = '#16a34a';
            status.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>GPS: ${lat}, ${lon}`;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Get Current Location';
                btn.style.background = '#22c55e';
                btn.disabled = false;
            }, 2000);
        },
        function(error) {
            btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>GPS Error - Try Again';
            btn.style.background = '#dc2626';
            btn.disabled = false;
            status.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-1"></i>Error: ${error.message}`;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Get Current Location';
                btn.style.background = '#22c55e';
            }, 3000);
        },
        { 
            enableHighAccuracy: true, 
            timeout: 15000, 
            maximumAge: 60000 
        }
    );
}

function conductFieldAssessment() {
    const locationName = document.getElementById('locationName').value;
    const lat = document.getElementById('latitude').value;
    const lon = document.getElementById('longitude').value;
    
    if (!locationName || !lat || !lon) {
        alert('Please get location first or enter coordinates manually');
        return;
    }
    
    const btn = document.getElementById('assessButton');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing Environmental Data...';
    btn.disabled = true;
    
    // Conduct assessment on same page with field-friendly results
    const url = `/field-assessment/?lat=${lat}&lon=${lon}`;
    window.location.href = url;
}

function saveAssessment() {
    if (currentAssessment) {
        alert('Assessment saved to device storage');
        // In real implementation, save to local storage or sync when online
    }
}

function newAssessment() {
    window.location.href = '/field-assessment/';
}

function exportReport() {
    const timestamp = new Date().toLocaleString();
    
    // Check if we have assessment results
    const riskBadge = document.getElementById('riskBadge');
    const hasResults = riskBadge && riskBadge.textContent;
    
    let locationName = 'Field Assessment';
    let coordinates = 'GPS Location';
    let assessmentData = '';
    
    if (hasResults) {
        // Get data from assessment results
        const riskLevel = riskBadge.textContent.trim();
        const scoreElements = document.querySelectorAll('.results-card .h5');
        const score = scoreElements[0] ? scoreElements[0].textContent : 'N/A';
        const temp = scoreElements[1] ? scoreElements[1].textContent : 'N/A';
        const humidity = scoreElements[2] ? scoreElements[2].textContent : 'N/A';
        
        // Get coordinates from location summary
        const locationSummary = document.querySelector('.field-card .h6.text-success');
        if (locationSummary) {
            coordinates = locationSummary.textContent.trim();
            locationName = `Field Assessment ${coordinates}`;
        }
        
        assessmentData = `\n\nASSESSMENT RESULTS:\nRisk Level: ${riskLevel}\nRisk Score: ${score}\nTemperature: ${temp}\nHumidity: ${humidity}\n\nRECOMMENDATIONS BASED ON ${riskLevel}:`;
        
        if (riskLevel.includes('HIGH') || riskLevel.includes('EXTREME')) {
            assessmentData += `\n• Increase patrol frequency immediately\n• Prepare firefighting equipment\n• Alert nearby communities\n• Restrict access if possible`;
        } else if (riskLevel.includes('MODERATE')) {
            assessmentData += `\n• Monitor conditions closely\n• Check fire breaks\n• Ensure water access\n• Brief response teams`;
        } else {
            assessmentData += `\n• Continue normal patrols\n• Monitor weather changes\n• Maintain equipment readiness`;
        }
    } else {
        // Try to get coordinates from input fields if they exist
        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        if (latInput && lonInput && latInput.value && lonInput.value) {
            coordinates = `${latInput.value}, ${lonInput.value}`;
        }
    }
    
    const report = `FIELD FIRE RISK ASSESSMENT REPORT
    
Location: ${locationName}
Date/Time: ${timestamp}
Coordinates: ${coordinates}${assessmentData}

FIELD OBSERVATIONS CHECKLIST:
□ Vegetation dryness level: ___________
□ Wind direction: ___________
□ Wind speed (estimated): ___________
□ Recent rainfall: ___________
□ Water sources nearby: ___________
□ Access roads condition: ___________
□ Fire breaks present: ___________
□ Human activity level: ___________

RISK FACTORS:
□ Dry vegetation
□ High winds
□ No recent rain
□ Limited water access
□ Poor road access
□ No fire breaks
□ High human activity

RECOMMENDATIONS:
□ Increase patrol frequency
□ Prepare firefighting equipment
□ Alert nearby communities
□ Establish fire breaks
□ Improve water access

Field Officer: ___________
Signature: ___________

Generated by MsituGuard Field Assessment Tool`;

    const blob = new Blob([report], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `field_assessment_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
}

function reportFire() {
    const modal = new bootstrap.Modal(document.getElementById('fireReportModal'));
    modal.show();
}

function getFireLocation() {
    if (!navigator.geolocation) {
        alert('GPS not supported on this device');
        return;
    }

    const btn = event.target;
    const status = document.getElementById('fireLocationStatus');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Getting GPS...';
    btn.disabled = true;
    status.textContent = 'Acquiring GPS coordinates...';

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            
            document.getElementById('fireLocation').value = `Fire Location: ${lat}, ${lon}`;
            
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Location Acquired';
            btn.style.background = '#16a34a';
            status.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>GPS: ${lat}, ${lon}`;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Use Current Location';
                btn.style.background = '#22c55e';
                btn.disabled = false;
            }, 2000);
        },
        function(error) {
            btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>GPS Error';
            btn.style.background = '#dc2626';
            btn.disabled = false;
            status.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-1"></i>Error: ${error.message}`;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Use Current Location';
                btn.style.background = '#22c55e';
            }, 3000);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
}

function submitFireReport() {
    const observation = document.getElementById('observation').value;
    const location = document.getElementById('fireLocation').value;
    const notes = document.getElementById('fireNotes').value;
    const image = document.getElementById('fireImage').files[0];
    
    if (!observation || !location) {
        alert('Please fill in observation type and location');
        return;
    }
    
    if (!image) {
        alert('Photo evidence is required for fire reports');
        return;
    }
    
    // Simulate fire report submission
    const reportData = {
        observation: observation,
        location: location,
        notes: notes,
        timestamp: new Date().toLocaleString(),
        reporter: 'Field Worker'
    };
    
    // Close modal and show success
    bootstrap.Modal.getInstance(document.getElementById('fireReportModal')).hide();
    
    alert(`🚨 FIRE REPORT SUBMITTED\n\nObservation: ${observation.toUpperCase()}\nLocation: ${location}\nTime: ${reportData.timestamp}\n\n✅ Emergency teams notified\n✅ Organization dashboard updated\n✅ Response teams dispatched`);
    
    // In real implementation, this would POST to /report-fire-observation/
}

function alertTeams() {
    if (confirm('Alert nearby response teams about current risk level?')) {
        alert('🚨 ALERT SENT\n\n✅ Fire response teams notified\n✅ Emergency services alerted\n✅ Nearby stations contacted\n\nTeams will receive:\n• Current risk assessment\n• GPS coordinates\n• Weather conditions\n• Recommended actions');
    }
}

// Auto-save location when manually entered (only if elements exist)
if (document.getElementById('latitude')) {
    document.getElementById('latitude').addEventListener('change', updateLocationStatus);
    document.getElementById('longitude').addEventListener('change', updateLocationStatus);
}

function updateLocationStatus() {
    const lat = document.getElementById('latitude')?.value;
    const lon = document.getElementById('longitude')?.value;
    const status = document.getElementById('locationStatus');
    
    if (lat && lon && status) {
        status.innerHTML = `<i class="fas fa-map-marker-alt text-success me-1"></i>Manual coordinates: ${lat}, ${lon}`;
    } else if (status) {
        status.textContent = '';
    }
}
</script>

{% endblock %}