{% extends 'App/base.html' %}
{% load static %}

{% block title %}Fire Safety Center - MsituGuard{% endblock %}

{% block content %}
<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @keyframes glow {
        0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.6); }
    }
    
    .page-header {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        padding: 4rem 0 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 70%, rgba(255,255,255,0.1) 0%, transparent 50%);
    }
    
    .fire-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border: 2px solid transparent;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
    }
    
    .fire-card.danger {
        border-color: #22c55e;
        box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2);
    }
    
    .fire-card.warning {
        border-color: #22c55e;
        box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2);
    }
    
    .fire-card.primary {
        border-color: #22c55e;
        box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2);
    }
    
    .fire-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34,197,94,0.05), transparent);
        transition: left 0.8s ease;
    }
    
    .fire-card:hover::after {
        left: 100%;
    }
    
    .fire-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(34, 197, 94, 0.2);
    }
    
    .risk-banner {
        animation: glow 3s infinite;
        border-radius: 15px !important;
    }
    
    .btn-fire {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        display: inline-block;
        border: none;
    }
    
    .btn-fire:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 15px 40px rgba(34, 197, 94, 0.4);
        color: white;
    }
    
    .fire-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    }
    
    .fire-icon.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .fire-icon.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .fire-icon.primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    

    
    .info-card {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border: 2px solid #22c55e;
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        animation: fadeInUp 1s ease-out;
    }
    
    .modal-fire .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }
    
    .modal-fire .modal-header {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-radius: 20px 20px 0 0;
        border: none;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .page-header {
            padding: 2rem 0 1rem;
        }
        
        .page-header h1 {
            font-size: 2rem;
        }
        
        .page-header p {
            font-size: 1rem;
        }
        
        .fire-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .fire-icon {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
        
        .btn-fire {
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            display: block;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            margin-bottom: 0.5rem;
            border-radius: 25px !important;
        }
        
        .table-responsive {
            font-size: 0.85rem;
        }
        
        .modal-dialog {
            margin: 1rem;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .risk-banner {
            padding: 1.5rem !important;
        }
        
        .risk-banner .d-flex {
            flex-direction: column;
            text-align: center;
        }
        
        .risk-banner .text-end {
            text-align: center !important;
            margin-top: 1rem;
        }
    }
    
    @media (max-width: 480px) {
        .page-header {
            padding: 1.5rem 0 1rem;
            background-size: cover !important;
            background-position: center center !important;
        }
        
        .page-header h1 {
            font-size: 1.5rem;
        }
        
        .page-header p {
            font-size: 0.9rem;
        }
        
        .fire-card {
            padding: 1rem;
            border-radius: 15px;
        }
        
        .fire-icon {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }
        
        .btn-fire {
            padding: 0.7rem 1rem;
            font-size: 0.85rem;
        }
        
        .card-title {
            font-size: 1rem;
        }
        
        .table-responsive {
            font-size: 0.75rem;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
        }
        
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-body {
            padding: 0.8rem;
        }
        
        .modal-header h5 {
            font-size: 1rem;
        }
        
        .form-control {
            font-size: 0.9rem;
        }
        
        .btn {
            font-size: 0.85rem;
        }
        
        .risk-banner {
            padding: 1rem !important;
        }
        
        .badge {
            font-size: 0.7rem;
        }
    }
</style>
<!-- Page Header -->
<div class="page-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.4), rgba(220, 38, 38, 0.4)), url('{% static 'images/forest2.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; color: white; padding: 4rem 0 2rem; text-align: center; position: relative; overflow: hidden;">
    <div class="container" style="position: relative; z-index: 2;">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div class="text-center flex-grow-1">
                <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: white; font-size: 2rem;">
                    <i class="fas fa-fire"></i>
                </div>
                <h1 class="display-4 fw-bold mb-3">🔥 Fire Safety Center</h1>
                <p class="lead fs-5">Real-time fire risk assessment and community fire reporting</p>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="btn-group">
                    {% if user.is_authenticated %}
                        {% if not has_location %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assessRiskModal">
                            📊 Assess Fire Risk
                        </button>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}" class="btn btn-primary">
                            📊 Login for Risk Assessment
                        </a>
                    {% endif %}
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#reportFireModal">
                        🚨 Report Fire Observation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Cards -->
    {% if not has_location %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="fire-card primary">
                <div class="text-center">
                    <div class="fire-icon primary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="fw-bold mb-3">📊 Assess Fire Risk</h5>
                    <p class="text-muted mb-3">Get real-time fire risk analysis for your location based on weather and environmental data.</p>
                    {% if user.is_authenticated %}
                    <p class="text-success"><small><i class="fas fa-check-circle me-1"></i>Click "Assess Fire Risk" above to analyze current conditions in your area.</small></p>
                    {% else %}
                    <p class="text-primary"><small><i class="fas fa-sign-in-alt me-1"></i><a href="{% url 'login' %}" class="text-decoration-none">Login</a> to access fire risk assessment and track your environmental contributions.</small></p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="fire-card warning">
                <div class="text-center">
                    <div class="fire-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h5 class="fw-bold mb-3">🚨 Report Fire Observation</h5>
                    <p class="text-muted mb-3">Spotted smoke, flames, or signs of fire? Report it immediately to help protect our forests.</p>
                    {% if not user.is_authenticated %}
                    <p class="text-danger"><small><i class="fas fa-fire me-1"></i>No login required for urgent fire reports - help save our forests!</small></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Fire Risk Prediction Results -->
    {% if prediction %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>🔥 Current Fire Risk Assessment</h5>
                </div>
                <div class="card-body">
                    <div class="risk-banner p-4 rounded mb-4" style="background: {{ prediction.color }}20; border: 2px solid {{ prediction.color }};">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge fs-6 px-3 py-2" style="background: {{ prediction.color }}; color: white;">{{ prediction.level }}</span>
                                <div class="mt-2">
                                    <strong>Risk Score: {{ prediction.score }}</strong>
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">
                                    Location: {{ prediction.lat|floatformat:3 }}, {{ prediction.lon|floatformat:3 }}<br>
                                    Assessed: {{ prediction.timestamp|date:"M d, Y H:i" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">🌤️ Weather Conditions</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Temperature:</strong> {{ prediction.weather.temp_c }}°C</li>
                                        <li><strong>Humidity:</strong> {{ prediction.weather.humidity }}%</li>
                                        <li><strong>Wind Speed:</strong> {{ prediction.weather.wind_speed_ms }} m/s</li>
                                        <li><strong>Rainfall (24h):</strong> {{ prediction.weather.rainfall_mm_24h }} mm</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">🌿 Vegetation Index</h6>
                                    {% if prediction.ndvi %}
                                        <p class="mb-0"><strong>NDVI:</strong> {{ prediction.ndvi|floatformat:3 }}</p>
                                        <small class="text-muted">Vegetation density indicator</small>
                                    {% else %}
                                        <p class="mb-0 text-muted">NDVI data not available</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">🔥 Recent Fire Activity</h6>
                                    <p class="mb-0"><strong>{{ prediction.recent_fires }}</strong> fires</p>
                                    <small class="text-muted">Within 25km (last 7 days)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MISTRAL AI Analysis -->
                    {% if prediction.ai_analysis %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-brain me-2"></i>AI Fire Risk Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary"><i class="fas fa-exclamation-triangle me-1"></i>Risk Explanation</h6>
                                            <p class="mb-3">{{ prediction.ai_analysis.risk_explanation }}</p>
                                            
                                            <h6 class="text-success"><i class="fas fa-shield-alt me-1"></i>Prevention Tips</h6>
                                            <p class="mb-3">{{ prediction.ai_analysis.prevention_tips }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Emergency Actions</h6>
                                            <p class="mb-3">{{ prediction.ai_analysis.emergency_actions }}</p>
                                            
                                            <h6 class="text-info"><i class="fas fa-calendar-alt me-1"></i>Seasonal Outlook</h6>
                                            <p class="mb-0">{{ prediction.ai_analysis.seasonal_outlook }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- How It Works -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5>📊 How Fire Risk Assessment Works</h5>
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="mb-2">🌡️</div>
                            <strong>Weather Data</strong>
                            <small class="d-block text-muted">Temperature, humidity, wind, rainfall</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="mb-2">🌿</div>
                            <strong>Vegetation</strong>
                            <small class="d-block text-muted">Plant density and dryness levels</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="mb-2">🔥</div>
                            <strong>Fire History</strong>
                            <small class="d-block text-muted">Recent fires in your area</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="mb-2">📊</div>
                            <strong>Risk Level</strong>
                            <small class="d-block text-muted">LOW, MODERATE, HIGH, EXTREME</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Predictions -->
    {% if user.is_authenticated %}
    <div class="row">
        <div class="col-md-8">
            <div class="fire-card">
                <div class="d-flex align-items-center mb-4">
                    <div class="fire-icon danger me-3">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="fw-bold mb-0">📈 My Fire Risk Assessments</h5>
                </div>
                {% if recent_predictions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Risk Level</th>
                                    <th>Risk Score</th>
                                    <th>Date</th>
                                    <th>Assessed By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prediction in recent_predictions %}
                                <tr>
                                    <td>{{ prediction.location_name }}</td>
                                    <td>
                                        {% if prediction.risk_level == 'LOW' %}
                                            <span class="badge" style="background-color: #16a34a;">{{ prediction.risk_level }}</span>
                                        {% elif prediction.risk_level == 'MODERATE' %}
                                            <span class="badge" style="background-color: #eab308;">{{ prediction.risk_level }}</span>
                                        {% elif prediction.risk_level == 'HIGH' %}
                                            <span class="badge" style="background-color: #f97316;">{{ prediction.risk_level }}</span>
                                        {% else %}
                                            <span class="badge" style="background-color: #dc2626;">{{ prediction.risk_level }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ prediction.risk_score|floatformat:2 }}</td>
                                    <td>{{ prediction.created_at|date:"M d, Y H:i" }}</td>
                                    <td>{{ prediction.created_by.username|default:"System" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <div class="fire-icon warning mx-auto mb-3">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <p class="text-muted">No fire risk assessments yet. Click "Assess Fire Risk" to create the first assessment.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Citizen Reports -->
        <div class="col-md-4">
            <div class="fire-card danger">
                <div class="d-flex align-items-center mb-4">
                    <div class="fire-icon warning me-3">
                        <i class="fas fa-users"></i>
                    </div>
                    <h5 class="fw-bold mb-0">👥 Citizen Fire Reports</h5>
                </div>
                {% if recent_reports %}
                    {% for report in recent_reports %}
                    <div class="border-bottom pb-3 mb-3" style="border-color: #f1f5f9 !important;">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                    <i class="fas fa-fire" style="font-size: 0.9rem;"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-1">{{ report.location_name }}</h6>
                                <p class="text-muted mb-1" style="font-size: 0.9rem;">{{ report.get_observation_display }} - {{ report.created_at|date:"M d, H:i" }}</p>
                                {% if report.notes %}
                                    <p class="text-secondary mb-0" style="font-size: 0.8rem;">{{ report.notes|truncatewords:8 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <div class="fire-icon primary mx-auto mb-3">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <p class="text-muted">No citizen reports yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Public User Message -->
    <div class="row">
        <div class="col-12">
            <div class="info-card">
                <div class="fire-icon primary mx-auto mb-4">
                    <i class="fas fa-fire"></i>
                </div>
                <h5 class="fw-bold text-primary mb-3">🔥 Join Our Fire Safety Community</h5>
                <p class="text-muted mb-4">You can report fire observations without an account! To unlock additional features like fire risk assessment, viewing community reports, and earning tokens, please create an account.</p>
                <div class="mt-3">
                    <a href="{% url 'register' %}" class="btn-fire me-3">🌱 Create Free Account</a>
                    <a href="{% url 'login' %}" class="btn btn-outline-primary" style="border-radius: 25px; padding: 1rem 2rem;">Login</a>
                </div>
                <p class="text-muted mt-3"><small><i class="fas fa-users me-1"></i>Join thousands of Kenyans protecting our forests and environment!</small></p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Assess Fire Risk Modal -->
<div class="modal fade" id="assessRiskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📊 Assess Fire Risk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Choose how you want to assess fire risk in your area:</p>
                
                <div class="text-center">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title text-success">📍 Detect My Location</h6>
                            <p class="card-text text-muted mb-3">Automatically detect your current location and get instant fire risk analysis</p>
                            <button id="detectLocationBtn" class="btn btn-success btn-lg">
                                <i class="fas fa-location-arrow me-2"></i>Detect My Location
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fire Report Modal (Available for all users) -->
<div class="modal fade modal-fire" id="reportFireModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">🚨 Report Fire Observation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'report_fire_observation' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {% if not user.is_authenticated %}
                    <div class="mb-3">
                        <label class="form-label">Your Name</label>
                        <input type="text" class="form-control" name="reporter_name" required 
                               placeholder="Enter your full name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" name="reporter_phone" required 
                               placeholder="e.g., +254712345678">
                        <small class="text-muted">We may need to contact you for follow-up</small>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <button type="button" id="useCurrentLocationBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-location-arrow me-1"></i>Use Current Location
                        </button>
                        <small class="text-muted d-block mt-1">Click to automatically detect your coordinates</small>
                        <div id="coordinatesDisplay" class="mt-2" style="display: none;">
                            <small class="text-success">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <strong>Location detected:</strong> <span id="coordsText"></span>
                            </small>
                        </div>
                        <input type="hidden" name="latitude" id="reportLatitude" required>
                        <input type="hidden" name="longitude" id="reportLongitude" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">What did you observe?</label>
                        <select class="form-control" name="observation" required>
                            <option value="">Select observation...</option>
                            <option value="smoke">Smoke</option>
                            <option value="heat">Heat</option>
                            <option value="flames">Flames</option>
                            <option value="smell">Burning smell</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="Describe what you observed..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Photo</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Automatic location detection for fire risk assessment
const detectBtns = document.querySelectorAll('#detectLocationBtn, #detectLocationBtn2');
detectBtns.forEach(btn => {
    if (btn) {
        btn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Detecting Location...';
            btn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const url = `{% url 'fire_risk' %}?lat=${latitude}&lon=${longitude}`;
                    window.location.href = url;
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert('Could not get your location. Please allow location access and try again.');
                    btn.innerHTML = '<i class="fas fa-location-arrow me-2"></i>Use My Location';
                    btn.disabled = false;
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 60000 
                }
            );
        });
    }
});

// Use current location for fire reporting
const useLocationBtn = document.getElementById('useCurrentLocationBtn');
if (useLocationBtn) {
    useLocationBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
        }
        
        useLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Getting Location...';
        useLocationBtn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                document.getElementById('reportLatitude').value = latitude.toFixed(6);
                document.getElementById('reportLongitude').value = longitude.toFixed(6);
                document.getElementById('reportLatitude').value = latitude.toFixed(6);
                document.getElementById('reportLongitude').value = longitude.toFixed(6);
                
                // Show coordinates to user
                document.getElementById('coordsText').textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                document.getElementById('coordinatesDisplay').style.display = 'block';
                
                useLocationBtn.innerHTML = '<i class="fas fa-check me-1"></i>Location Detected';
                useLocationBtn.classList.remove('btn-outline-primary');
                useLocationBtn.classList.add('btn-success');
                useLocationBtn.disabled = true;
            },
            (error) => {
                console.error('Geolocation error:', error);
                alert('Could not get your location. Please allow location access and try again.');
                useLocationBtn.innerHTML = '<i class="fas fa-location-arrow me-1"></i>Use Current Location';
                useLocationBtn.disabled = false;
            },
            { 
                enableHighAccuracy: true, 
                timeout: 10000, 
                maximumAge: 60000 
            }
        );
    });
}
</script>
{% endblock %}