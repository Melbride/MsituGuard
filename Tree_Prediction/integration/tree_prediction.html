{% extends 'App/base.html' %}
{% load static %}

{% block title %}Tree Survival Prediction - MsituGuard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-tree"></i> Tree Survival Prediction</h4>
                    <p class="mb-0">Get AI-powered predictions for tree survival based on environmental conditions</p>
                </div>
                <div class="card-body">
                    <form id="predictionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="tree_species">Tree Species</label>
                                    <select class="form-control" id="tree_species" name="tree_species" required>
                                        <option value="Eucalyptus">Eucalyptus</option>
                                        <option value="Pine">Pine</option>
                                        <option value="Acacia">Acacia</option>
                                        <option value="Cypress">Cypress</option>
                                        <option value="Cedar">Cedar</option>
                                        <option value="Grevillea">Grevillea</option>
                                        <option value="Neem">Neem</option>
                                        <option value="Wattle">Wattle</option>
                                        <option value="Bamboo">Bamboo</option>
                                        <option value="Casuarina">Casuarina</option>
                                        <option value="Jacaranda">Jacaranda</option>
                                        <option value="Indigenous Mix">Indigenous Mix</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="region">Region</label>
                                    <select class="form-control" id="region" name="region" required>
                                        <option value="Central">Central</option>
                                        <option value="Coast">Coast</option>
                                        <option value="Eastern">Eastern</option>
                                        <option value="Nairobi">Nairobi</option>
                                        <option value="North Eastern">North Eastern</option>
                                        <option value="Northern">Northern</option>
                                        <option value="Nyanza">Nyanza</option>
                                        <option value="Rift Valley">Rift Valley</option>
                                        <option value="Western">Western</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="county">County</label>
                                    <select class="form-control" id="county" name="county" required>
                                        <option value="Nairobi">Nairobi</option>
                                        <option value="Kiambu">Kiambu</option>
                                        <option value="Machakos">Machakos</option>
                                        <option value="Mombasa">Mombasa</option>
                                        <option value="Nakuru">Nakuru</option>
                                        <option value="Eldoret">Eldoret</option>
                                        <option value="Kisumu">Kisumu</option>
                                        <option value="Nyeri">Nyeri</option>
                                        <option value="Meru">Meru</option>
                                        <option value="Kitui">Kitui</option>
                                        <option value="Garissa">Garissa</option>
                                        <option value="Turkana">Turkana</option>
                                        <option value="Marsabit">Marsabit</option>
                                        <option value="Kakamega">Kakamega</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="soil_type">Soil Type</label>
                                    <select class="form-control" id="soil_type" name="soil_type" required>
                                        <option value="Loam">Loam</option>
                                        <option value="Clay">Clay</option>
                                        <option value="Sandy">Sandy</option>
                                        <option value="Rocky">Rocky</option>
                                        <option value="Red Soil">Red Soil</option>
                                        <option value="Black Cotton">Black Cotton</option>
                                        <option value="Volcanic">Volcanic</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="planting_season">Planting Season</label>
                                    <select class="form-control" id="planting_season" name="planting_season" required>
                                        <option value="Wet">Wet Season</option>
                                        <option value="Dry">Dry Season</option>
                                        <option value="Transition">Transition</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="planting_method">Planting Method</label>
                                    <select class="form-control" id="planting_method" name="planting_method" required>
                                        <option value="Seedling">Seedling</option>
                                        <option value="Direct Seeding">Direct Seeding</option>
                                        <option value="Cutting">Cutting</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="rainfall_mm">Annual Rainfall (mm)</label>
                                    <input type="number" class="form-control" id="rainfall_mm" name="rainfall_mm" 
                                           value="600" min="200" max="2000" required>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="temperature_c">Average Temperature (Â°C)</label>
                                    <input type="number" class="form-control" id="temperature_c" name="temperature_c" 
                                           value="20" min="5" max="40" step="0.1" required>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="altitude_m">Altitude (meters)</label>
                                    <input type="number" class="form-control" id="altitude_m" name="altitude_m" 
                                           value="1500" min="0" max="4000" required>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="soil_ph">Soil pH</label>
                                    <input type="number" class="form-control" id="soil_ph" name="soil_ph" 
                                           value="6.5" min="4" max="9" step="0.1" required>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="care_level">Care Level</label>
                                    <select class="form-control" id="care_level" name="care_level" required>
                                        <option value="Low">Low</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="water_source">Water Source</label>
                                    <select class="form-control" id="water_source" name="water_source" required>
                                        <option value="Rain-fed">Rain-fed</option>
                                        <option value="Irrigation">Irrigation</option>
                                        <option value="Borehole">Borehole</option>
                                        <option value="River">River</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="tree_age_months">Tree Age (months)</label>
                                    <input type="number" class="form-control" id="tree_age_months" name="tree_age_months" 
                                           value="12" min="1" max="120" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-chart-line"></i> Predict Survival
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card" id="resultsCard" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-chart-pie"></i> Prediction Results</h5>
                </div>
                <div class="card-body">
                    <div id="predictionResults"></div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h6><i class="fas fa-info-circle"></i> How it Works</h6>
                </div>
                <div class="card-body">
                    <p class="small">Our AI model analyzes:</p>
                    <ul class="small">
                        <li>Environmental conditions</li>
                        <li>Soil characteristics</li>
                        <li>Climate data</li>
                        <li>Tree species requirements</li>
                        <li>Care and maintenance factors</li>
                    </ul>
                    <p class="small text-muted">Based on real data from Kenya's environmental monitoring systems.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convert numeric fields
    data.rainfall_mm = parseFloat(data.rainfall_mm);
    data.temperature_c = parseFloat(data.temperature_c);
    data.altitude_m = parseFloat(data.altitude_m);
    data.soil_ph = parseFloat(data.soil_ph);
    data.tree_age_months = parseInt(data.tree_age_months);
    
    try {
        const response = await fetch('/api/predict-tree-survival/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        displayResults(result);
        
    } catch (error) {
        console.error('Error:', error);
        displayError('Failed to get prediction. Please try again.');
    }
});

function displayResults(result) {
    const resultsCard = document.getElementById('resultsCard');
    const resultsDiv = document.getElementById('predictionResults');
    
    if (result.success) {
        const riskColor = getRiskColor(result.risk_level);
        
        resultsDiv.innerHTML = `
            <div class="text-center mb-3">
                <div class="display-4 text-success">${result.survival_percentage}%</div>
                <p class="text-muted">Survival Probability</p>
            </div>
            
            <div class="alert alert-${riskColor} text-center">
                <strong>Risk Level: ${result.risk_level}</strong>
            </div>
            
            <div class="mt-3">
                <h6>Recommendation:</h6>
                <p class="small">${result.recommendation}</p>
            </div>
            
            <div class="progress mt-3">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: ${result.survival_percentage}%" 
                     aria-valuenow="${result.survival_percentage}" 
                     aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
        `;
    } else {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>Error:</strong> ${result.error}
            </div>
        `;
    }
    
    resultsCard.style.display = 'block';
}

function getRiskColor(riskLevel) {
    switch(riskLevel) {
        case 'Low': return 'success';
        case 'Medium': return 'warning';
        case 'High': return 'danger';
        case 'Very High': return 'danger';
        default: return 'secondary';
    }
}

function displayError(message) {
    const resultsDiv = document.getElementById('predictionResults');
    resultsDiv.innerHTML = `
        <div class="alert alert-danger">
            <strong>Error:</strong> ${message}
        </div>
    `;
    document.getElementById('resultsCard').style.display = 'block';
}
</script>
{% endblock %}